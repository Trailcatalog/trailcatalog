var tcLabel=L.Label.extend({onAdd:function(){L.Label.prototype.onAdd.apply(this,arguments)},onRemove:function(){this.trashLink&&L.DomEvent.removeListener(this.trashLink,"click",this._trashIconClicked);L.Label.prototype.onRemove.apply(this,arguments)},setHighlight:function(a){a?L.DomUtil.addClass(this._container,"highlight"):L.DomUtil.removeClass(this._container,"highlight")},_updateContent:function(){this._content&&this._map&&this._prevContent!==this._content&&(this.options.cssClass&&L.DomUtil.addClass(this._container,
this.options.cssClass),"string"===typeof this._content&&(L.DomUtil.create("span","",this._container).innerHTML=this._content,"marker-start"!=this.options.cssClass&&(this.trashLink&&L.DomEvent.removeListener(this.trashLink,"click",this._trashIconClicked),this.trashLink=L.DomUtil.create("a","",this._container),this.trashLink.setAttribute("href","javascript:void(0);"),this.trashLink.innerHTML='<img src="img/edit-delete.svg" width="12" height="12"/>',L.DomEvent.addListener(this.trashLink,"click",this._trashIconClicked,
this)),this._prevContent=this._content,this._labelWidth=this._container.offsetWidth,this._labelHeight=this._container.offsetHeight))},_setPosition:function(a){var b=this._map,d=this._container,c=b.latLngToContainerPoint(b.getCenter()),b=b.layerPointToContainerPoint(a),f=this.options.direction,e=this._labelWidth,h=this._labelHeight,g=L.point(this.options.offset);"right"===f||"auto"===f&&b.x<c.x?(L.DomUtil.addClass(d,"leaflet-label-right"),L.DomUtil.removeClass(d,"leaflet-label-left"),g.x-=e/2,g.y-=
h/2,a=a.add(g)):(L.DomUtil.addClass(d,"leaflet-label-left"),L.DomUtil.removeClass(d,"leaflet-label-right"),a=a.add(L.point(-g.x-e,g.y)));L.DomUtil.setPosition(d,a)},_trashIconClicked:function(a){L.DomEvent.stopPropagation(a);this.fire("remove",a);this.setHighlight(!0)}});L.tc=L.tc||{};L.tc.Label=function(a,b){return new tcLabel(a,b)};var tcSegment=L.FeatureGroup.extend({includes:L.Mixin.Events,options:{routeStyle:{color:"#FF8000",weight:4,opacity:.75},highlightStyle:{color:"#A70005",weight:4,opacity:.75},labelCssClass:"",state:"on",readOnly:!1},elevation:0,initialize:function(a,b,d,c,f,e){L.setOptions(this,f);L.FeatureGroup.prototype.initialize.call(this,[],f);this.markerStart=a;this.markerEnd=b;this.directionsAPI=d;this.surfaceAPI=c;this.path=e;this._draw()},_draw:function(){this.clearLayers();this.label=this.line=null;if(this.path)this.line=
L.polyline(this.path,this.options.routeStyle).addTo(this);else{var a=[this.markerStart.getLatLng(),this.markerEnd.getLatLng()];this.line=L.polyline(a,this.options.routeStyle).addTo(this)}this._calcDistance();this._calcElevation()},_calcDistance:function(){for(var a=this.line.getLatLngs(),b=0,d=0;d<a.length-1;d++)b+=a[d].distanceTo(a[d+1]);a=this._getSegmentCenter(a,b);this.label&&(this.label.off("remove",this._removeSegment,this),this.label=null);this.label=new L.tc.Label({offset:[0,0],segmentIndex:0,
cssClass:this.options.labelCssClass});this.distance=b=Math.round(b/10*.621371)/100;this.label.setContent(b+" Mi");this.label.setLatLng(a);this.addLayer(this.label);this.label.on("remove",this._removeSegment,this)},_calcElevation:function(){var a=this;if(this.surfaceAPI){var b=this.line.getLatLngs();this.surfaceAPI.getElevations(b,this instanceof tcStraightSegment,function(b,c){if(!b&&c&&c.length){for(var f=0,e=c[0],h=1;h<c.length;h++)e=c[h]-e,0<e&&(f+=e),e=c[h];a.elevation=3*f;28084}})}},_getSegmentCenter:function(a,
b){for(var d=0,c=0;c<=a.length-1;c++)if(d+=a[c].distanceTo(a[c+1]),d>b/2)return L.latLngBounds(a[c],a[c+1]).getCenter()},_removeSegment:function(a){var b=this;this.line.setStyle(this.options.highlightStyle);setTimeout(function(){b.clearLayers();b.options.state="off";b.fire("removed")},500)},getDistance:function(){return this.distance},getElevation:function(){return this.elevation}}),tcRouteSegment=tcSegment.extend({_draw:function(){var a=this;this.clearLayers();this.label=this.line=null;if(this.path)a.line=
L.polyline(this.path,a.options.routeStyle).addTo(a),a._calcDistance(),a._calcElevation();else{var b=[this.markerStart.getLatLng(),this.markerEnd.getLatLng()];this.directionsAPI.getRoute(b,function(d,c){!d&&c.length&&(c[0]=b[0],a.markerEnd.setLatLng(c[c.length-1]),a.line=L.polyline(c,a.options.routeStyle).addTo(a),a._calcDistance(),a._calcElevation(),"function"===typeof a.options.callback&&a.options.callback())})}}}),tcStraightSegment=tcSegment.extend({options:{routeStyle:{color:"#0674D7",weight:4,
opacity:.75},endMarkerIcon:L.divIcon({className:"marker-map-unsnapped"}),labelCssClass:"straightLable"},tempEndMarker:null,addPoint:function(a){this.line.addLatLng(a);this._setTempEndMarker()},endDraw:function(a){this.markerEnd=a;this._clearTempEndMarker();this._calcDistance();this._calcElevation()},_draw:function(){this.path?(this.line=L.polyline(this.path,this.options.routeStyle).addTo(this),this._calcDistance(),this._calcElevation()):this.line=L.polyline([this.markerStart.getLatLng()],this.options.routeStyle).addTo(this)},
_setTempEndMarker:function(){this._clearTempEndMarker();var a=this.line.getLatLngs();a.length&&(this.tempEndMarker=L.marker(a[a.length-1],{icon:this.options.endMarkerIcon}).addTo(this))},_clearTempEndMarker:function(){this.tempEndMarker&&(this.removeLayer(this.tempEndMarker),this.tempEndMarker=null)},getLastLatLng:function(){var a=null,b=this.line.getLatLngs();b.length&&1<b.length&&(a=b[b.length-1]);return a}});L.tc=L.tc||{};L.tc.Segment=function(a,b,d,c,f,e){return new tcSegment(a,b,d,f,e)};
L.tc.RouteSegment=function(a,b,d,c,f){return new tcRouteSegment(a,b,d,c,f)};L.tc.StraightSegment=function(a,b,d){return new tcStraightSegment(a,null,null,b,d)};L.tc.restoreSegment=function(a,b,d,c,f,e,h){return a?new tcStraightSegment(b,d,f,e,h,c):new tcRouteSegment(b,d,f,e,h,c)};var tcStaticRouteLayer=L.FeatureGroup.extend({waypoints:[],initialize:function(a){L.setOptions(this,a);L.FeatureGroup.prototype.initialize.call(this,[]);this.routeSegments=L.featureGroup().addTo(this);this.routeWaypoints=L.featureGroup().addTo(this)},_addWaypoint:function(a){a=L.marker(a,{icon:this._waypointIcon()}).addTo(this.routeWaypoints);this.waypoints.push(a);1==this.waypoints.length&&this.showStartMarker();return a},onAdd:function(){L.FeatureGroup.prototype.onAdd.apply(this,arguments)},restoreRouteFromJSON:function(a,
b){for(var d=a.waypoints,c=a.segments,f=null,e=L.geoJson(d).getLayers(),h={},g=0;g<e.length;g++){var k=e[g].getLatLng();f?f.extend(k):f=L.latLngBounds(k,k);k=this._addWaypoint(k);h[d.features[g].properties.stamp]=k}d=L.geoJson(c).getLayers();for(g=0;g<d.length;g++){var e=c.features[g].properties.straight,k=h[c.features[g].properties.markerStart],l=h[c.features[g].properties.markerEnd],m=d[g].getLatLngs(),e=L.tc.restoreSegment(e,k,l,m,this.directionsAPI,this.surfaceAPI,{labelCssClass:"label-read-only"});
this.routeSegments.addLayer(e)}b.fitBounds(f)},showStartMarker:function(){this.startLabel&&(this.removeLayer(this.startLabel),this.startLabel=null);if(this.waypoints.length){var a=this.waypoints[0];this.startLabel=new L.tc.Label({offset:[0,-16],cssClass:"marker-start"});this.startLabel.setContent("START");this.startLabel.setLatLng(a.getLatLng());this.addLayer(this.startLabel)}},_waypointIcon:function(){return L.divIcon({className:"marker-map"})}});L.tc=L.tc||{};L.tc.StaticRouteLayer=function(a){return new tcStaticRouteLayer(a)};var mapEngine={options:{zoom:15,tileLayerName:"runkeeper.4nc7syvi",mapContainerId:"map",mapBoxApiKey:"pk.eyJ1IjoiYXJzZW55biIsImEiOiI3YkwwSGpFIn0.sz_Ar78nUbUZc6Ic1aNhkQ"},init:function(a){L.setOptions(this,a);L.mapbox.accessToken=this.options.mapBoxApiKey;this.map=L.mapbox.map(this.options.mapContainerId,this.options.tileLayerName,{zoomControl:!1});this.routeLayer=L.tc.StaticRouteLayer().addTo(this.map);"undefined"!==typeof trailData&&this.restoreTrail()},restoreTrail:function(){this.routeLayer.restoreRouteFromJSON(trailData,
this.map)}};$(function(){mapEngine.init()});
